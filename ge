import re
import fitz  # PyMuPDF
import dateutil.parser

def extract_latest_amendment_date(file_path):
    latest_amendment = {"amendment": None, "date": None}
    found_protocol_summary = False

    with fitz.open(file_path) as doc:
        for page in doc:
            text = page.get_text("text")  # Extract raw text

            # Check if "PROTOCOL SUMMARY" is found
            if "PROTOCOL SUMMARY" in text:
                found_protocol_summary = True

            if found_protocol_summary:
                # Extract amendment numbers and dates using regex
                amendment_matches = re.findall(r"Amendment\s*(\d+)", text, re.IGNORECASE)
                date_matches = re.findall(r"(\d{1,2}\s+\w+\s+\d{4}|\d{1,2}/\d{1,2}/\d{4}|\d{4}-\d{2}-\d{2})", text)

                amendments = [int(num) for num in amendment_matches]  # Convert amendment numbers to integers
                
                # Process amendment-date pairs
                for i in range(len(amendments)):
                    if i < len(date_matches):  # Ensure we don't go out of range
                        try:
                            parsed_date = dateutil.parser.parse(date_matches[i], fuzzy=True)

                            # Update latest amendment if:
                            # - It's the highest amendment number
                            # - Or same amendment number but newer date
                            if (latest_amendment["amendment"] is None or 
                                amendments[i] > latest_amendment["amendment"] or
                                (amendments[i] == latest_amendment["amendment"] and parsed_date > latest_amendment["date"])):
                                
                                latest_amendment["amendment"] = amendments[i]
                                latest_amendment["date"] = parsed_date

                        except Exception:
                            continue  # Skip if date parsing fails

                # Stop searching after "PROTOCOL SUMMARY"
                break  

    # Format the extracted date
    if latest_amendment["date"]:
        latest_amendment["date"] = latest_amendment["date"].strftime("%d %B %Y")

    return latest_amendment

# Example usage
file_path = "sample_protocol.pdf"
result = extract_latest_amendment_date(file_path)
print("Latest Amendment:", result)
